<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Earth Calendar - Data Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <!-- Messaggio di stato -->
    <div id="statusMessage"></div>

    <!-- Header -->
    <div class="header">
        <h1>The Earth Calendar</h1>
        <p>Data Management</p>
    </div>

    <!-- Contenuto -->
    <div class="service-content">
        <h2>Manage Your Earth Calendar Data</h2>
        
        <p>
            Export all your data (Weekly & Septennial Agenda, Logbook, Goals) for backup.<br>
            Import data to restore from an existing backup.
        </p>
        
        <div class="service-buttons">
            <button id="exportAllBtn" class="btn-export">Export All Data</button>
            <button id="importAllBtn" class="btn-import">Import All Data</button>
            <br>
            <a href="../wkly/index.html" class="btn-back">Back to Weekly Agenda</a>
        </div>
        
        <div class="warning">
            <strong>Important Warning:</strong><br>
            1. Always export before importing.<br>
            2. Importing will REPLACE ALL current data.<br>
            3. Data is stored locally in your browser.
        </div>
        
        <!-- Status dei moduli -->
        <div id="moduleStatus" class="module-status" style="display: none;">
            <strong>Module Status</strong>
            <div class="module-item" id="weeklyStatus">Checking Weekly Agenda...</div>
            <div class="module-item" id="logbookStatus">Checking Logbook...</div>
            <div class="module-item" id="goalsStatus">Checking Goals...</div>
            <div class="module-item" id="septennialStatus">Checking Septennial Agenda...</div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>
            <a href="../../index.htm" target="_blank"><b>The Earth Calendar</b></a> 
            - Data Management - Version 1.1
            <br>
            Concordance with <a href="../../dt/index.html" target="_blank"><b>Epoch Time</b></a>
        </p>
    </div>

    <!-- JavaScript -->
    <!-- TEC Date functions (condiviso) -->
    <script src="tec_date.js"></script>
    
    <script>
        // ===== UTILITY =====
        function showStatus(message, duration) {
            duration = duration || 3000;
            var statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'show';
            
            setTimeout(function() {
                statusEl.className = '';
            }, duration);
        }
        
        // ===== CONTROLLO MODULI =====
        function checkModules() {
            var modulesAvailable = 0;
            var moduleStatusEl = document.getElementById('moduleStatus');
            
            // 1. Weekly Agenda
            if (window.earthCalendarDB && typeof window.earthCalendarDB.isInitialized === 'function') {
                if (window.earthCalendarDB.isInitialized()) {
                    document.getElementById('weeklyStatus').innerHTML = 
                        '<span class="module-ok">✓ Weekly Agenda: Available</span>';
                    modulesAvailable++;
                } else {
                    document.getElementById('weeklyStatus').innerHTML = 
                        '<span class="module-warning">⚠ Weekly Agenda: DB not initialized (open agenda first)</span>';
                }
            } else {
                document.getElementById('weeklyStatus').innerHTML = 
                    '<span class="module-error">✗ Weekly Agenda: Module not loaded</span>';
            }
            
            // 2. Logbook (non ancora implementato)
            document.getElementById('logbookStatus').innerHTML = 
                '<span class="module-na">○ Logbook: Not yet available</span>';
            
            // 3. Goals (non ancora implementato)
            document.getElementById('goalsStatus').innerHTML = 
                '<span class="module-na">○ Goals: Not yet available</span>';
            
            // 4. Septennial (non ancora implementato)
            document.getElementById('septennialStatus').innerHTML = 
                '<span class="module-na">○ Septennial Agenda: Not yet available</span>';
            
            // Mostra status se almeno un modulo è disponibile
            if (modulesAvailable > 0) {
                moduleStatusEl.style.display = 'block';
            }
            
            return modulesAvailable;
        }
        
        // ===== ESPORTAZIONE =====
        function exportAllData() {
            // Controlla se l'agenda è disponibile
            if (!window.earthCalendarDB || !window.earthCalendarDB.isInitialized()) {
                showStatus('Weekly Agenda database not ready. Please open the agenda first.');
                return;
            }
            
            showStatus('Exporting Weekly Agenda data...');
            
            // Usa la NUOVA funzione getAllWeeklyData() (non exportAllData()!)
            window.earthCalendarDB.getAllWeeklyData().then(function(weeklyData) {
                // Crea struttura dati completa (per futuri moduli)
                var exportData = {
                    exportDate: new Date().toISOString(),
                    version: "1.1",
                    earthCalendar: true,
                    modules: {
                        weekly_agenda: weeklyData,
                        logbook: { available: false, message: "Module not yet implemented" },
                        goals: { available: false, message: "Module not yet implemented" },
                        septennial_agenda: { available: false, message: "Module not yet implemented" }
                    }
                };
                
                // Converti in JSON
                var jsonData = JSON.stringify(exportData, null, 2);
                
                // Crea file download
                var blob = new Blob([jsonData], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                
                // Nome file con data
                var today = new Date();
                var dateStr = today.getFullYear() + '-' + 
                             ('0' + (today.getMonth() + 1)).slice(-2) + '-' + 
                             ('0' + today.getDate()).slice(-2);
                a.download = 'earth-calendar-data-' + dateStr + '.json';
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Weekly Agenda exported successfully (other modules coming soon)');
                
            }).catch(function(error) {
                console.error('Export error:', error);
                showStatus('Error during export: ' + (error.message || 'Unknown error'));
            });
        }
        
        // ===== IMPORT =====
        function importAllData() {
            // Controlla se l'agenda è disponibile
            if (!window.earthCalendarDB || !window.earthCalendarDB.isInitialized()) {
                showStatus('Weekly Agenda database not ready. Please open the agenda first.');
                return;
            }
            
            // Avviso importante
            var warningMsg = 'WARNING: This will replace ALL your current Weekly Agenda data.\n\n' +
                           'Other modules (Logbook, Goals, Septennial) are not yet available.\n\n' +
                           'Do you want to continue?';
            
            if (!confirm(warningMsg)) {
                return;
            }
            
            // Crea input file
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            
            input.onchange = function(event) {
                var file = event.target.files[0];
                if (!file) return;
                
                showStatus('Importing data...');
                
                var reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        var jsonData = e.target.result;
                        var data = JSON.parse(jsonData);
                        
                        // Validazione file
                        if (!data.earthCalendar || !data.modules) {
                            showStatus('Error: Not a valid Earth Calendar backup file');
                            return;
                        }
                        
                        // Importa solo l'agenda settimanale (per ora)
                        if (data.modules.weekly_agenda) {
                            window.earthCalendarDB.importWeeklyData(data.modules.weekly_agenda)
                                .then(function(result) {
                                    showStatus('Success! ' + result.imported + ' weeks imported to Weekly Agenda');
                                })
                                .catch(function(error) {
                                    console.error('Import error:', error);
                                    showStatus('Import error: ' + (error.message || 'Unknown error'));
                                });
                        } else {
                            showStatus('Error: No Weekly Agenda data found in backup file');
                        }
                        
                    } catch (error) {
                        console.error('File error:', error);
                        showStatus('Error: Invalid or corrupted JSON file');
                    }
                };
                
                reader.onerror = function() {
                    showStatus('Error reading file');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // ===== INIZIALIZZAZIONE =====
        window.onload = function() {
            // Controlla moduli disponibili
            var availableModules = checkModules();
            
            // Setup pulsanti
            document.getElementById('exportAllBtn').onclick = exportAllData;
            document.getElementById('importAllBtn').onclick = importAllData;
            
            // Messaggio iniziale
            if (availableModules > 0) {
                showStatus('Data Management ready (Weekly Agenda available)', 2000);
            } else {
                showStatus('Open Weekly Agenda first to enable data management', 4000);
                document.getElementById('exportAllBtn').disabled = true;
                document.getElementById('importAllBtn').disabled = true;
            }
        };
    </script>

</body>
</html>
